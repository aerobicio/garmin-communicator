<html>
  <head>
    <meta charset="utf-8">
    <title>gamin-communicator tests</title>
    <script src="../spec/contrib/jquery.js"></script>
    <script src="../node_modules/lodash/lodash.underscore.js"></script>
    <script src="../node_modules/q/q.js"></script>
    <script src="backbone.js"></script>
    <script src="rivets.js"></script>
    <script src="../garmin.js"></script>
  </head>
  <body>

    <nav id="devices">
      <h3>Devices</h3>
      <details rv-each-device="devices">
        <summary>
          <code>{{ device.id }}</code> - <span>{{ device.attributes.name }}</span>
          <button rv-on-click="controller.activities">Load Activities</button>
        </summary>
        <code>
          <table>
            <tr>
              <td>canReadActivities</td>
              <td>{{ device.attributes.device.canReadActivities }}</td>
            </tr>
            <tr>
              <td>canReadWorkouts</td>
              <td>{{ device.attributes.device.canReadWorkouts }}</td>
            </tr>
            <tr>
              <td>canReadCourses</td>
              <td>{{ device.attributes.device.canReadCourses }}</td>
            </tr>
            <tr>
              <td>canReadGoals</td>
              <td>{{ device.attributes.device.canReadGoals }}</td>
            </tr>
            <tr>
              <td>canReadProfile</td>
              <td>{{ device.attributes.device.canReadProfile }}</td>
            </tr>
            <tr>
              <td>canReadFITActivities</td>
              <td>{{ device.attributes.device.canReadFITActivities }}</td>
            </tr>
          </table>
        </code>
      </details>
    </nav>

    <hr>

    <div id="device-progress">
      <progress value="0" rv-value="progress.attributes.percent" max="100"></progress>
      {{ progress.attributes.percent }}%
      <code>{{ progress.attributes.message }}</code>
    </div>

    <hr>

    <div id="workouts">
      <h3>Workouts</h3>
      <ol>
        <li rv-each-workout="workouts">
          <code>{{ workout.attributes.id }}</code> {{ workout.attributes.date }} {{ workout.attributes.path }}
          <button rv-on-click="controller.getData">Get Data</button>
        </li>
      </ol>
    </div>

    <div id="device-data">
      <h3>Workout Data</h3>
      <pre><code>{{ data.attributes.data }}</code></pre>
    </div>

    <script>
      $(function(){
        rivets.configure({templateDelimiters: ['{{', '}}']})

        var unlockCodes = {
          "http://aerobic.io:8000/example/": "208ce96db2618ddb3a6ba6efa58b76cd"
        };
        var garmin            = new Garmin({unlockCodes: unlockCodes})
        var deviceDataModel   = new Backbone.Model()
        var workoutsCollection = new Backbone.Collection()
        var progressModel     = new Backbone.Model()
        var devicesCollection = new Backbone.Collection()

        var deviceController = {
          activities: function(event, collection){
            deviceDataModel.set({ data: "" })
            progressModel.set({ message: "", percent: 0 })

            promise = collection.device.attributes.device.activities()

            promise.progress(function(progress){
              progressModel.set({ message: progress.message, percent: progress.percent })
            }.bind(this)).then(function(workouts){
              workouts.forEach(function(workout){
                workoutsCollection.add(new Backbone.Model({
                  id:       workout.id,
                  date:     workout.date,
                  path:     workout.path,
                  workout:  workout
                }))
              })
            }.bind(this))
          }
        }

        var activityController = {
          getData: function(event, collection) {
            collection.workout.attributes.workout.getData().then(function(data){
              deviceDataModel.set({ data: JSON.stringify(data) })
            })
          }
        }

        rivets.bind($('#devices'),          { devices: devicesCollection.models, controller: deviceController })
        rivets.bind($('#device-progress'),  { progress: progressModel })
        rivets.bind($('#device-data'),      { data: deviceDataModel })
        rivets.bind($('#workouts'),        { workouts: workoutsCollection.models, controller: activityController })

        garmin.devices().then(function(devices){
          devices.forEach(function(device){
            devicesCollection.add(new Backbone.Model({
              id:               device.id,
              name:             device.name,
              partNumber:       device.partNumber,
              softwareVersion:  device.softwareVersion,
              device:           device
            }))
          })
        })
      })
    </script>
  </body>
</html>
