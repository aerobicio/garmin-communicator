<html>
  <head>
    <meta charset="utf-8">
    <title>gamin-communicator tests</title>
    <script src="../contrib/jquery.js"></script>
    <script src="../node_modules/underscore/underscore.js"></script>
    <script src="../node_modules/q/q.js"></script>
    <script src="backbone.js"></script>
    <script src="rivets.js"></script>
    <script src="../dist/garmin.js"></script>
  </head>
  <body>

    <nav id="devices">
      <details rv-each-device="devices">
        <summary>
          <code>{{ device.id }}</code> - <span>{{ device.attributes.name }}</span>
          <button rv-on-click="controller.activities">Load Activities</button>
        </summary>
        <code>
          <table>
            <tr>
              <td>canReadActivities</td>
              <td>{{ device.attributes.device.canReadActivities }}</td>
            </tr>
            <tr>
              <td>canReadWorkouts</td>
              <td>{{ device.attributes.device.canReadWorkouts }}</td>
            </tr>
            <tr>
              <td>canReadCourses</td>
              <td>{{ device.attributes.device.canReadCourses }}</td>
            </tr>
            <tr>
              <td>canReadGoals</td>
              <td>{{ device.attributes.device.canReadGoals }}</td>
            </tr>
            <tr>
              <td>canReadProfile</td>
              <td>{{ device.attributes.device.canReadProfile }}</td>
            </tr>
            <tr>
              <td>canReadFITActivities</td>
              <td>{{ device.attributes.device.canReadFITActivities }}</td>
            </tr>
          </table>
        </code>
      </details>
    </nav>

    <hr>

    <div id="device-progress">
      <progress value="0" rv-value="progress.attributes.percent" max="100">{{ progress.attributes.percent }} %</progress>
      <code>{{ progress.attributes.message }}</code>
    </div>

    <hr>

    <pre><code id="device-data">{{ data.attributes.data }}</code></pre>

    <script>
      $(function(){
        rivets.configure({templateDelimiters: ['{{', '}}']})

        var garmin            = new Garmin()
        var deviceDataModel   = new Backbone.Model()
        var progressModel     = new Backbone.Model()
        var deviceModel       = Backbone.Model.extend()
        var devicesCollection = new Backbone.Collection()
        var deviceController = {
          activities: function(event, collection){
            deviceDataModel.set({ data: "" })
            progressModel.set({ message: "", percent: 0 })

            if (collection.device.attributes.device.canReadFITActivities) {
              promise = collection.device.attributes.device.readFITActivities()
            } else {
              promise = collection.device.attributes.device.readActivities()
            }

            promise.progress(function(progress){
              progressModel.set({ message: progress.message, percent: progress.percent })
            }.bind(this)).then(function(data){
              deviceDataModel.set({ data: data })
            }.bind(this))
          }
        }

        rivets.bind($('#devices'), { devices: devicesCollection.models, controller: deviceController })
        rivets.bind($('#device-progress'), { progress: progressModel })
        rivets.bind($('#device-data'), { data: deviceDataModel })

        garmin.devices().then(function(devices){
          devices.forEach(function(device){
            devicesCollection.add(new deviceModel({
              id:               device.id,
              name:             device.name,
              partNumber:       device.partNumber,
              softwareVersion:  device.softwareVersion,
              device:           device
            }))
          })
        })
      })
    </script>
  </body>
</html>
